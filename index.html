<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CHRONICLES - Corporate Knowledge Base</title>
    <meta name="description" content="Professional corporate knowledge management system for enterprise organizations" />
    <meta name="author" content="Chronicles" />
    
    <!-- Professional Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <meta property="og:title" content="2b3bafc7-932e-479f-acf8-325a0d6b87ab" />
    <meta property="og:description" content="Lovable Generated Project" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- ElevenLabs ConvAI Widget -->
    <elevenlabs-convai agent-id="agent_4301k60jbejbebzr750zdg463tr4"></elevenlabs-convai>
    <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

    <!-- ElevenLabs Widget Event Integration -->
    <script>
      // Listen for ElevenLabs widget events and forward them to the React app
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ðŸŽ§ Chronicles ElevenLabs integration loaded');

        // Function to dispatch custom events to the React app
        function dispatchConversationEvent(type, data) {
          console.log('ðŸ“¡ Dispatching conversation event:', type, data);
          window.postMessage({
            type: type,
            ...data,
            source: 'elevenlabs-widget'
          }, window.location.origin);
        }

        // Monitor for ElevenLabs widget lifecycle events
        let widgetCheckInterval = setInterval(() => {
          const widget = document.querySelector('elevenlabs-convai');
          if (widget && widget.shadowRoot) {
            console.log('âœ… ElevenLabs widget found, setting up event listeners');

            // Clear the interval once widget is found
            clearInterval(widgetCheckInterval);

            // Try to access widget events through the shadow DOM or global events
            // Note: ElevenLabs may expose events differently, this is a general approach

            // Listen for potential widget events on the window
            window.addEventListener('message', function(event) {
              if (event.data && event.data.type && event.data.type.startsWith('elevenlabs')) {
                console.log('ðŸŽ¯ ElevenLabs event detected:', event.data);

                if (event.data.type === 'elevenlabs-call-ended' ||
                    event.data.type === 'elevenlabs-conversation-ended' ||
                    event.data.conversationStatus === 'ended') {

                  dispatchConversationEvent('elevenlabs-conversation-ended', {
                    conversationId: event.data.conversationId || event.data.conversation_id || 'unknown',
                    agentId: event.data.agentId || event.data.agent_id || 'agent_4301k60jbejbebzr750zdg463tr4',
                    timestamp: Date.now()
                  });
                }
              }
            });

            // Also listen for changes in the widget's internal state
            // This is a fallback approach using mutation observers
            const observer = new MutationObserver(function(mutations) {
              mutations.forEach(function(mutation) {
                // Check if the widget shows a "call ended" or similar state
                if (mutation.type === 'childList' || mutation.type === 'attributes') {
                  const widgetContent = widget.shadowRoot ? widget.shadowRoot.textContent : widget.textContent;
                  if (widgetContent && (
                    widgetContent.toLowerCase().includes('call ended') ||
                    widgetContent.toLowerCase().includes('conversation ended') ||
                    widgetContent.toLowerCase().includes('session complete')
                  )) {
                    console.log('ðŸ” Widget state suggests conversation ended');
                    // Trigger conversation end event
                    setTimeout(() => {
                      dispatchConversationEvent('elevenlabs-conversation-ended', {
                        conversationId: 'detected_' + Date.now(),
                        agentId: 'agent_4301k60jbejbebzr750zdg463tr4',
                        timestamp: Date.now(),
                        detectionMethod: 'mutation-observer'
                      });
                    }, 2000); // Wait 2 seconds for ElevenLabs to process
                  }
                }
              });
            });

            // Start observing the widget for changes
            if (widget.shadowRoot) {
              observer.observe(widget.shadowRoot, {
                childList: true,
                subtree: true,
                attributes: true
              });
            }
            observer.observe(widget, {
              childList: true,
              subtree: true,
              attributes: true
            });
          }
        }, 1000);

        // Clear interval after 30 seconds if widget not found
        setTimeout(() => {
          clearInterval(widgetCheckInterval);
        }, 30000);
      });
    </script>
  </body>
</html>
